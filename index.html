<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="google-site-verification" content="60X2GmvcaR6V9UhVAcZ_ocF3hDA94DOhRLyX9QJ0q9Y" />










  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description" content="Fake it until make it !">
<meta property="og:type" content="website">
<meta property="og:title" content="Ctf成长之路">
<meta property="og:url" content="http://blog.ctf826.com/index.html">
<meta property="og:site_name" content="Ctf成长之路">
<meta property="og:description" content="Fake it until make it !">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Ctf成长之路">
<meta name="twitter:description" content="Fake it until make it !">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>




  <link rel="canonical" href="http://blog.ctf826.com/"/>

  <title> Ctf成长之路 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-79892610-1', 'auto');
  ga('send', 'pageview');
</script>


  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?80beb08edaff9ea62979309c248cbe10";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Ctf成长之路</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/06/24/搭建基于jenkins+github+fir.im自动化集成环境/" itemprop="url">
                  搭建基于jenkins+github+fir.im自动化集成环境
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-06-24T15:35:03+08:00" content="2016-06-24">
              2016-06-24
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/环境配置/" itemprop="url" rel="index">
                    <span itemprop="name">环境配置</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/06/24/搭建基于jenkins+github+fir.im自动化集成环境/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/06/24/搭建基于jenkins+github+fir.im自动化集成环境/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <a id="more"></a>
<h1 id="自动集成环境介绍"><a href="#自动集成环境介绍" class="headerlink" title="自动集成环境介绍"></a>自动集成环境介绍</h1><p>在实际开发环境中，出于种种原因，不得不构建一个自动化集成环境来提高效率。网上找了一下资料，发现虽然乍一看方法千千万，但大部分iOS自动集成环境核心都是基于 jenkins 来实现的。<br>翻看了相关的部分资料，最后选择用 jenkins + github + fir.im 来构建自己的自动化继承环境。</p>
<h2 id="jenkins"><a href="#jenkins" class="headerlink" title="jenkins"></a>jenkins</h2><blockquote>
<p>Jenkins是一个用Java编写的开源的持续集成工具。在与Oracle发生争执后，项目从Hudson项目复刻。<br>Jenkins提供了软件开发的持续集成服务。它运行在Servlet容器中（例如Apache Tomcat）。它支持软件配置管理（SCM）工具（包括AccuRev SCM、CVS、Subversion、Git、Perforce、Clearcase和和RTC），可以执行基于Apache Ant和Apache Maven的项目，以及任意的Shell脚本和Windows批处理命令。Jenkins的主要开发者是川口耕介。[2]Jenkins是在MIT许可证下发布的自由软件。[3]<br>可以通过各种手段触发构建。例如提交给版本控制系统时被触发，也可以通过类似Cron的机制调度，也可以在其他的构建已经完成时，还可以通过一个特定的URL进行请求。<br>来源—<a href="https://zh.wikipedia.org/wiki/Jenkins_(软件" target="_blank" rel="external">维基百科</a>)</p>
</blockquote>
<h2 id="github"><a href="#github" class="headerlink" title="github"></a>github</h2><blockquote>
<p>GitHub是一个利用Git进行版本控制、专门用于存放软件代码与内容的共享虚拟主机服务。它由GitHub公司（曾称Logical Awesome）的开发者Chris Wanstrath、PJ Hyett和Tom Preston-Werner使用Ruby on Rails编写而成。<br>GitHub同时提供付费账户和免费账户。这两种账户都可以建立公开的代码仓库，但是付费账户也可以建立私有的代码仓库。根据在2009年的Git用户调查，GitHub是最流行的Git存取站点。[2]除了允许个人和组织建立和存取代码库以外，它也提供了一些方便社会化软件开发的功能，包括允许用户追蹤其他用户、组织、软件库的动态，对软件代码的改动和bug提出评论等。GitHub也提供了图表功能，用于显示开发者们怎样在代码库上工作以及软件的开发活跃程度。<br>截止到2015年，GitHub已经有超过九百万注册用户和2110万代码库。[3]事实上已经成为了世界上最大的代码存放网站和开源社区。[4]<br>来源—<a href="https://zh.wikipedia.org/wiki/GitHub" target="_blank" rel="external">维基百科</a></p>
</blockquote>
<h2 id="fir-im"><a href="#fir-im" class="headerlink" title="fir.im"></a>fir.im</h2><blockquote>
<p>fir.im 为开发者提供测试应用极速发布，应用崩溃实时分析、用户反馈收集等一系列开发测试效率工具服务，帮助开发者将更多精力放在产品的开发与应用的优化上。<br>来源—<a href="https://fir.im" target="_blank" rel="external">维基百科</a></p>
</blockquote>
<p>#安装</p>
<h2 id="jenkins安装"><a href="#jenkins安装" class="headerlink" title="jenkins安装"></a>jenkins安装</h2><p>在网上各种教程中，Mac上 jenkins 安装具体有两种:</p>
<ol>
<li><p>官网直接下载 —-<a href="jenkins.io">网址</a></p>
</li>
<li><p>homebrew、brew 安装</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew cask install jenkins</span><br></pre></td></tr></table></figure>
<p>个人推荐用第一种方法直接从官网下载，通过图形界面安装。因为我在实际安装过程中发现通过homebrew安装的jenkins版本稍低于常用版本，导致后面某些插件无法使用。</p>
<p>jenkins安装完成之后，可以通过<a href="http://localhost:8080" target="_blank" rel="external">浏览器</a>访问了。  </p>
<p><img src="/images/WeChat_1468899662.jpeg" alt="WeChat_1468899662"></p>
<p>(<del>~使用的为英文系统，所以界面也默认是英文。应该产生不了阅读障碍吧。。。。。。</del>~)</p>
<h2 id="插件安装"><a href="#插件安装" class="headerlink" title="插件安装"></a>插件安装</h2><p>插件安装方法： Manage Jenkins -&gt; Manage Plugins</p>
<p><img src="/images/2.pic_hd.jpg" alt="2.pic_hd"></p>
<p>所需插件如下：</p>
<blockquote>
<p>git plugin</p>
<p>github plugin</p>
<p>Xcode integration</p>
<p>Post-Build Script Plug-in</p>
</blockquote>
<h2 id="jenkins配置"><a href="#jenkins配置" class="headerlink" title="jenkins配置"></a>jenkins配置</h2><p>jenkins以及插件都已经安装完成了，那就可以开始愉快的配置jenkins了。jenkins配置其实主要配的就几个点,jenkins从什么地方拉取代码，这个大部分是用git管理了，所以基本填的也应该是git服务器地址咯。然后就是代码拉取下来之后的打包，打完包之后上传指定托管网站。网上的配置方法的不同，大致就是打包使用的方法不同。</p>
<p>因为我准备使用的是上传到fir.im。且fir.im有个插件支持一键打包上传，所以只要在jenkins配置一行命令就能实现打包并上传的流程。so 我选择的是这种方法。</p>
<h3 id="新建项目"><a href="#新建项目" class="headerlink" title="新建项目"></a>新建项目</h3><p>选择New Item -&gt; 填写项目名 -&gt; 选择 Freestyle project -&gt; OK</p>
<p><img src="/images/5.pic_hd.jpg" alt="5.pic_hd"></p>
<p>创建完项目之后，填写项目名称，描述等等，可以选择性的勾选 GitHub project 填写自己的github仓库地址。这样创建完之后，在侧边会有一个按钮可以直接转跳到github上。</p>
<p><img src="/images/6.pic_hd.jpg" alt="6.pic_hd"></p>
<p>可以转跳到指定仓库的按钮</p>
<p><img src="/images/7.pic.jpg" alt="7.pi"></p>
<h3 id="指定源码地址"><a href="#指定源码地址" class="headerlink" title="指定源码地址"></a>指定源码地址</h3><p>填完一些基本信息之后，就需要配置源码地址了。因为我是放在github上面托管，所以选择git。然后填上你的仓库地址。如果是公开仓库，其他都选默认就OK了，配置完成。</p>
<p><img src="/images/8.pic_hd.jpg" alt="8.pic_hd"></p>
<p>如果是私有仓库，则需要配置证书才能通过验证来拉取代码。点击Add添加。<br>默认选择用户密码验证<br>Username: 用户名<br>Password: 密码<br>ID Description: 填不填无所谓</p>
<p><img src="/images/10.pic_hd.jpg" alt="10.pic_hd"></p>
<h3 id="触发构建"><a href="#触发构建" class="headerlink" title="触发构建"></a>触发构建</h3><p>说来惭愧，本来是想配置成 github 每次 commit Jenkins就自动打包上传一次，配置起来出了点小问题，研究一下没弄明白，后面就弃坑了。等什么时候有空了再重新来弄一下。<br>所以就配置了每天早上8点跟晚上7点自动打包上传。这条配置怎么写，点击边上的问号，会有详细的解释。<br><img src="/images/11.pic.jpg" alt="11.pi"></p>
<h3 id="打包上传"><a href="#打包上传" class="headerlink" title="打包上传"></a>打包上传</h3><p>打包上传需要用到fir.im的一个插件<a href="https://github.com/FIRHQ/fir-cli/blob/master/README.md" target="_blank" rel="external">fir-cli</a>.</p>
<p>安装：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gem install fir-cli</span><br></pre></td></tr></table></figure>
<p>安装完成后继续配置，选择 Execute shell。</p>
<p><img src="/images/12.pic.jpg" alt="12.pi"></p>
<p>填入如下命令 -&gt; 保存 -&gt; 立即构建</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fir build_ipa $&#123;WORKSPACE&#125;  -p -T #API Token#</span><br></pre></td></tr></table></figure>
<p>${WORKSPACE} 是指定jenkins中默认的项目地址。<br>API Token 是fir.im给定的，可以自己去fir.im上生成。</p>
<p>如果你的项目没有使用Cocoapods来管理第三方库的话，到上面这一步，就已经完成了。如果使用了，那么恭喜你，还得结往下看。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fir build_ipa $&#123;WORKSPACE&#125;/ -w  -S # Schemes # -p -T #API Token#</span><br></pre></td></tr></table></figure>
<p>增多了两个参数 -w -S ，w表示workspace 默认可以不填，-S 代表 Schemes 。因为使用了cocoapods管理的项目，需要指定 Schemes才能准确通过编译。</p>
<p>更多的命令解释清参考<a href="https://github.com/FIRHQ/fir-cli/blob/master/README.md" target="_blank" rel="external">fir-cli</a>。</p>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>配置完成，点击立即构建。构建历史可以看到历史的每一次构建。<br><img src="/images/13.pic.jpg" alt="13.pi"></p>
<p>点击可以进入查看单次构建详情。</p>
<p><img src="/images/14.pic_hd.jpg" alt="14.pic_hd"></p>
<p>点击 console output 可以查看构建的具体情况。</p>
<p><img src="/images/15.pic_hd.jpg" alt="15.pic_hd"></p>
<p>拉到最底部就能看到，我已经构建成功，并上传到fir.im了。<br><img src="/images/16.pic_hd.jpg" alt="16.pic_hd"></p>
<p>上到fir.im就可以直接扫码下载了</p>
<p>#存在问题</p>
<ol>
<li>因为项目中我提前配好了证书与描述文件，也默认读者能自行配置好，所以就没有写关于证书与描述文件的东西。fir.im上面应该也有详细的说明，不懂的可以自行上去查看。</li>
<li>在我的想象中，我觉得自动化集成环境，应该是每次有新的提交，就自动打包上传，扫码直接可下载最新版本，并且有自动语法检测，自动测试等功能。<strong>但是</strong> 实际并没有想象中的那么美好，github hooks、自动测试、语法检测还是任重而道远。有空再来研究吧。如果有朋友有清晰明了的教程 还请各位不吝指教！！</li>
</ol>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/06/22/Core Data基本使用/" itemprop="url">
                  CoreData
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-06-22T15:42:27+08:00" content="2016-06-22">
              2016-06-22
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/技术/" itemprop="url" rel="index">
                    <span itemprop="name">技术</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/06/22/Core Data基本使用/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/06/22/Core Data基本使用/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <a id="more"></a>
<h3 id="什么是Core-Data"><a href="#什么是Core-Data" class="headerlink" title="什么是Core Data"></a>什么是Core Data</h3><p>在我的理解中，Core Data是苹果提供的一套模型缓存框架。该框架是对数据库的进一步封装，让使用者不用编辑复杂的sql语句，以及能使用图形界面来便捷的创建存储模型。(如果理解有误，敬请斧正 谢谢)<br>具体的描述可以参考<a href="http://objccn.io/issue-4-1/" target="_blank" rel="external">objcn.io</a>以及Core Data<a href="https://developer.apple.com/library/prerelease/content/documentation/Cocoa/Conceptual/CoreData/" target="_blank" rel="external">官方介绍</a>;</p>
<h3 id="Core-Data基本概念"><a href="#Core-Data基本概念" class="headerlink" title="Core Data基本概念"></a>Core Data基本概念</h3><p>Core Data中有几个基本的概念需要注意：(<del>术语感觉没有统一的翻译，按照自己感觉来，如有错误，那就请不要在乎这点细节</del>)</p>
<p><img src="/images/14667500638407.jpg" alt=""><br>（图片源自apple官方）</p>
<ul>
<li><strong>ManagedObjectContext(管理对象上下文)</strong></li>
</ul>
<p>管理对象上下文（Context），是Core Data在中用来管理 管理对象(ManageObject)与连接 持久化存储助理 (PersistentStoreCoordinator)。Context可以直接连接到Coordinator上也可以连接到另一个Context上由另一个Context再连接到Coordinator上。<br>Context为管理对象提供了一个展现空间，对象在Context中做的改变，如果你不主动save，是不会保存到存储中去的。所以它很便捷的提供了 撤销重做的功能。用户的所有增删改查操作也全部是通过context来完成的。</p>
<ul>
<li><strong>PersistentStoreCoordinator</strong></li>
</ul>
<p>持久化存储助理(Coordinator <del>到底是翻译成协调器还是助理，我表示也很懵逼</del>)是用来连接context、管理 管理对象模型(ManagedObjectModel)、连接存储对象(PersistentObjectStore)。</p>
<p>Coordinator把所有Store集中起来管理，提供给context一个统一的入口。所有的Context查询操作通过Coordinator来在所有store中查找。</p>
<ul>
<li><strong>ManagedObjectModel</strong></li>
</ul>
<p>管理对象模型(ManagedObjectModel)，我的理解就是在Core Data中相当于数据库中的表，用来描述管理对象(ManagedObject)的结构与属性。</p>
<ul>
<li><strong>ManagedObject</strong></li>
</ul>
<p>管理对象(ManagedObject)，就是通过管理对象模型定义的一个实体。也相当于数据库中表的一条记录。通过Context来创建与修改管理。</p>
<ul>
<li><strong>PersistentObjectStore</strong></li>
</ul>
<p>持久化存储(PersistentObjectStore),用来存储数据的…….</p>
<p>以上都是作者个人理解，可能会有偏差的地方。更多信息请参阅<a href="https://developer.apple.com/library/prerelease/content/documentation/DataManagement/Devpedia-CoreData/coreDataOverview.html" target="_blank" rel="external">官方文档</a>。</p>
<h3 id="Core-Data基本使用"><a href="#Core-Data基本使用" class="headerlink" title="Core Data基本使用"></a>Core Data基本使用</h3><p>要使用Core Data来存储数据，首先得初始化Core Data所需要的对象，以及建立对象之间的联系。</p>
<p>首先，创建NSManagedObjectContext对象，也就是context</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">NSManagedObjectContext</span> *)managedObjectContext&#123;</span><br><span class="line">    <span class="keyword">if</span> (_managedObjectContext == <span class="literal">nil</span>) &#123;</span><br><span class="line">        _managedObjectContext = [[<span class="built_in">NSManagedObjectContext</span> alloc]initWithConcurrencyType:<span class="built_in">NSMainQueueConcurrencyType</span>];</span><br><span class="line">        _managedObjectContext.persistentStoreCoordinator = <span class="keyword">self</span>.persistentStoreCoordinator;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> _managedObjectContext;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>context的初始化方法 <strong>initWithConcurrencyType</strong> 中需要你选定context的类型，该枚举有三种类型：<a href="http://stackoverflow.com/questions/11176275/when-to-use-core-datas-nsmainqueueconcurrencytype" target="_blank" rel="external">详细区别</a></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="built_in">NS_ENUM</span>(<span class="built_in">NSUInteger</span>, <span class="built_in">NSManagedObjectContextConcurrencyType</span>) &#123;</span><br><span class="line">    <span class="built_in">NSConfinementConcurrencyType</span>  = <span class="number">0x00</span>,</span><br><span class="line">    <span class="built_in">NSPrivateQueueConcurrencyType</span> = <span class="number">0x01</span>,</span><br><span class="line">    <span class="built_in">NSMainQueueConcurrencyType</span>    = <span class="number">0x02</span></span><br><span class="line">&#125; <span class="built_in">NS_ENUM_AVAILABLE</span>(<span class="number">10</span>_7,  <span class="number">5</span>_0);</span><br></pre></td></tr></table></figure>
<p>创建完context之后，还得将context与Coordinator联系起来。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">NSPersistentStoreCoordinator</span> *)persistentStoreCoordinator&#123;</span><br><span class="line">    <span class="keyword">if</span> (_persistentStoreCoordinator == <span class="literal">nil</span>) &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">NSURL</span> *storeUrl = [[<span class="keyword">self</span> applicationDocumentDirectoryUrl]URLByAppendingPathComponent:<span class="string">@"iDo.sqlite"</span>];</span><br><span class="line">        <span class="built_in">NSError</span> *error = <span class="literal">nil</span>;</span><br><span class="line">        _persistentStoreCoordinator = [[<span class="built_in">NSPersistentStoreCoordinator</span> alloc]initWithManagedObjectModel:<span class="keyword">self</span>.managedObjectModel];</span><br><span class="line">        [_persistentStoreCoordinator addPersistentStoreWithType:<span class="built_in">NSSQLiteStoreType</span> configuration:<span class="literal">nil</span> URL:storeUrl options:<span class="literal">nil</span> error:&amp;error];</span><br><span class="line">     &#125;</span><br><span class="line">    <span class="keyword">return</span> _persistentStoreCoordinator;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSURL</span> *)applicationDocumentDirectoryUrl&#123;</span><br><span class="line">   <span class="keyword">return</span> [[<span class="built_in">NSFileManager</span> defaultManager]URLsForDirectory:<span class="built_in">NSDocumentDirectory</span> inDomains:<span class="built_in">NSUserDomainMask</span>].lastObject;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Coordinator需要Model对象来进行初始化。并且通过<strong>addPersistentStoreWithType:</strong>方法与Store建立联系。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">NSManagedObjectModel</span> *)managedObjectModel&#123;</span><br><span class="line">    <span class="keyword">if</span> (_managedObjectModel == <span class="literal">nil</span>) &#123;</span><br><span class="line">        <span class="built_in">NSURL</span> *modelUrl = [[<span class="built_in">NSBundle</span> mainBundle]URLForResource:<span class="string">@"iDo"</span> withExtension:<span class="string">@".momd"</span>];</span><br><span class="line">        _managedObjectModel = [[<span class="built_in">NSManagedObjectModel</span> alloc]initWithContentsOfURL:modelUrl];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> _managedObjectModel;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>model对象初始化需要指定.momd文件，momd文件就是.xcdatamodeld编译产生的文件，所以文件不存在也不会报错。如果你项目中只有1个.xcdatamodeld文件，那么不指定也可以，Xcode会自动在项目中匹配到model。</p>
<p><strong>添加数据</strong></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//存储</span></span><br><span class="line"><span class="built_in">NSManagedObject</span> *entity = [<span class="built_in">NSEntityDescription</span> insertNewObjectForEntityForName:<span class="string">@"Entity"</span> inManagedObjectContext:<span class="keyword">self</span>.context];</span><br><span class="line"><span class="comment">//管理对象的属性可以使用点语法来访问</span></span><br><span class="line">entity.property = <span class="string">@"xxx"</span>;</span><br><span class="line"><span class="comment">//保存数据</span></span><br><span class="line">[<span class="keyword">self</span>.context save:<span class="literal">nil</span>];</span><br></pre></td></tr></table></figure>
<p><strong>查询数据</strong></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//创建一个查询对象</span></span><br><span class="line"><span class="built_in">NSFetchRequest</span> *request = [<span class="built_in">NSFetchRequest</span> fetchRequestWithEntityName:<span class="string">@"Entity"</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">//查询条件（如不填写默认返回全部）</span></span><br><span class="line"><span class="built_in">NSPredicate</span> *pre = [<span class="built_in">NSPredicate</span> predicateWithFormat:<span class="string">@"查询条件"</span>];</span><br><span class="line">request.predicate = pre;</span><br><span class="line"></span><br><span class="line"><span class="comment">//排序</span></span><br><span class="line"><span class="built_in">NSSortDescriptor</span> *sort = [<span class="built_in">NSSortDescriptor</span> sortDescriptorWithKey:<span class="string">@"用来排序的属性"</span> ascending:<span class="literal">NO</span>];</span><br><span class="line">request.sortDescriptors =@[sort];</span><br><span class="line"></span><br><span class="line"><span class="comment">//查询 （数组中包含所有符合条件的记录）</span></span><br><span class="line"><span class="built_in">NSArray</span> *array = [<span class="keyword">self</span>.context executeFetchRequest:request error:<span class="literal">nil</span>];</span><br></pre></td></tr></table></figure>
<p><strong>删除数据</strong></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"> <span class="comment">//创建一个查询对象</span></span><br><span class="line"> <span class="built_in">NSFetchRequest</span> *request = [<span class="built_in">NSFetchRequest</span> fetchRequestWithEntityName:<span class="string">@"Entity"</span>];</span><br><span class="line"></span><br><span class="line"> <span class="comment">//查询条件（如不填写默认返回全部）</span></span><br><span class="line"> <span class="built_in">NSPredicate</span> *pre = [<span class="built_in">NSPredicate</span> predicateWithFormat:<span class="string">@"查询条件"</span>];</span><br><span class="line"> request.predicate = pre;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//查询</span></span><br><span class="line"> <span class="built_in">NSArray</span> *array = [<span class="keyword">self</span>.context executeFetchRequest:request error:<span class="literal">nil</span>];</span><br><span class="line"> <span class="keyword">for</span> (Entity *entit <span class="keyword">in</span> array) &#123;</span><br><span class="line">     <span class="comment">//删除</span></span><br><span class="line">     [<span class="keyword">self</span>.context deleteObject:entit];</span><br><span class="line">     <span class="comment">//保存</span></span><br><span class="line">     [<span class="keyword">self</span>.context save:<span class="literal">nil</span>];</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p><strong>修改数据</strong></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"> <span class="comment">//创建一个查询对象</span></span><br><span class="line"> <span class="built_in">NSFetchRequest</span> *request = [<span class="built_in">NSFetchRequest</span> fetchRequestWithEntityName:<span class="string">@"Entity"</span>];</span><br><span class="line"></span><br><span class="line"> <span class="comment">//查询条件（如不填写默认返回全部）</span></span><br><span class="line"> <span class="built_in">NSPredicate</span> *pre = [<span class="built_in">NSPredicate</span> predicateWithFormat:<span class="string">@"查询条件"</span>];</span><br><span class="line"> request.predicate = pre;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//查询</span></span><br><span class="line"> <span class="built_in">NSArray</span> *array = [<span class="keyword">self</span>.context executeFetchRequest:request error:<span class="literal">nil</span>];</span><br><span class="line"> <span class="keyword">for</span> (Entity *entit <span class="keyword">in</span> array) &#123;</span><br><span class="line">     <span class="comment">//修改</span></span><br><span class="line">     entit.name = <span class="string">@"123"</span>;</span><br><span class="line">     <span class="comment">//保存</span></span><br><span class="line">     [<span class="keyword">self</span>.context save:<span class="literal">nil</span>];</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h3 id="Core-Data版本迁移"><a href="#Core-Data版本迁移" class="headerlink" title="Core Data版本迁移"></a>Core Data版本迁移</h3><p>项目中难免遇到需要修改实体结构，如果尚在开发中还好，直接删除重新安装。若已经上架则需要进行版本迁移，让旧版本的数据能够顺利转移到新版本中。</p>
<p>简单的版本迁移 Coordinator 可以直接推断出文件映射，但是复杂的版本迁移就需要自己手动添加文件映射。要让Coordinator支持自动推断，需要在创建Coordinator的时候添加一个字典，字典中包含以下内容。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//版本迁移所用字典</span></span><br><span class="line">     <span class="built_in">NSMutableDictionary</span>  *dictionary = [<span class="built_in">NSMutableDictionary</span> dictionary];</span><br><span class="line">     [dictionary setObject:@(<span class="literal">YES</span>) forKey:<span class="built_in">NSInferMappingModelAutomaticallyOption</span>];</span><br><span class="line">     [dictionary setObject:@(<span class="literal">YES</span>) forKey:<span class="built_in">NSMigratePersistentStoresAutomaticallyOption</span>];</span><br><span class="line">     <span class="built_in">NSError</span> *error = <span class="literal">nil</span>;</span><br><span class="line">    [_persistentStoreCoordinator addPersistentStoreWithType:<span class="built_in">NSSQLiteStoreType</span> configuration:<span class="literal">nil</span> URL:storeURL options:dictionary error:&amp;error]</span><br></pre></td></tr></table></figure>
<p>版本迁移首先需要选中.xcdatamodeld文件，Editor-&gt; Add Model Version 创建新版本。</p>
<p><img src="/images/Screen%20Shot%202016-06-24%20at%203.45.12%20PM.png" alt="Screen Shot 2016-06-24 at 3.45.12 P"></p>
<p>然后在右侧检测器中的Model Version中选中新版本。</p>
<p><img src="/images/Screen Shot 2016-06-24 at 3.49.37 PM.png" alt="Screen Shot 2016-06-24 at 3.49.37 P"></p>
<p>然后修改实体表，并更新实体文件。</p>
<p>最后创建xcmappingmodel文件 先选择旧集合，再选择新集合然后确定。</p>
<p>至此版本更新完成。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/05/23/Runtime 基本概念/" itemprop="url">
                  Runtime 基本概念
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-05-23T14:35:20+08:00" content="2016-05-23">
              2016-05-23
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/技术/" itemprop="url" rel="index">
                    <span itemprop="name">技术</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/05/23/Runtime 基本概念/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/05/23/Runtime 基本概念/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <a id="more"></a>
<h1 id="Runtime"><a href="#Runtime" class="headerlink" title="Runtime"></a>Runtime</h1><h2 id="objc-msgSend"><a href="#objc-msgSend" class="headerlink" title="objc_msgSend:"></a>objc_msgSend:</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id objc_msgSend(id self, SEL op,.....);</span><br></pre></td></tr></table></figure>
<h2 id="SEL"><a href="#SEL" class="headerlink" title="SEL"></a>SEL</h2><p><code>SEL</code>是一个方法选择器，可以用来查找方法。Objc中使用 <code>@selector()</code>,runtime 中使用 <code>sel_registerName</code>来获取<code>SEL</code>类型的方法选择器。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> objc_selector *SEL;</span><br></pre></td></tr></table></figure>
<h2 id="id"><a href="#id" class="headerlink" title="id"></a>id</h2><p><code>id</code>是一个指向实例的指针</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> struck objc_object *<span class="keyword">id</span></span><br></pre></td></tr></table></figure>
<p><code>objc_object</code> 是一个包换 <code>isa</code> 指针的结构体</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> objc_object &#123; Class isa ;&#125;;</span><br></pre></td></tr></table></figure>
<p><code>isa</code>不总指向实例对象所属的类</p>
<blockquote>
<p>Key-Value Observing Implementation Details</p>
<p>Automatic key-value observing is implemented using a technique called isa-swizzling.</p>
<p>The isa pointer, as the name suggests, points to the object’s class which maintains a dispatch table. This dispatch table essentially contains pointers to the methods the class implements, among other data.</p>
<p>When an observer is registered for an attribute of an object the isa pointer of the observed object is modified, pointing to an intermediate class rather than at the true class. As a result the value of the isa pointer does not necessarily reflect the actual class of the instance.</p>
<p>You should never rely on the isa pointer to determine class membership. Instead, you should use the class method to determine the class of an object instance.</p>
</blockquote>
<h2 id="Class"><a href="#Class" class="headerlink" title="Class"></a>Class</h2><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> objc_class *Class</span><br></pre></td></tr></table></figure>
<p><code>objc_calss</code>关联了超类指针<code>super_class</code>,类名<code>name</code>，成员变量<code>ivar</code>，方法<code>methodLists</code>,缓存<code>cache</code>，附属的协议<code>protocols</code>等。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> objc_class &#123;</span><br><span class="line">	Class isa  OBJC_ISA_AVAILABILITY;</span><br><span class="line"><span class="meta">#if !__OBJC2__</span></span><br><span class="line">	Class super_class										OBJC2_UNAVAILABLE;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *name										 OBJC2_UNAVAILABLE;</span><br><span class="line">	<span class="keyword">long</span> version											 OBJC2_UNAVAILABLE;</span><br><span class="line">	<span class="keyword">long</span> info												OBJC2_UNAVAILABLE;</span><br><span class="line">	<span class="keyword">long</span> instance_size									   OBJC2_UNAVAILABLE;</span><br><span class="line">	<span class="keyword">struct</span> objc_ivar_list *ivars							 OBJC2_UNAVAILABLE;</span><br><span class="line">	<span class="keyword">struct</span> objc_method_list **methodLists					OBJC2_UNAVAILABLE;</span><br><span class="line">	<span class="keyword">struct</span> objc_cache *cache								 OBJC2_UNAVAILABLE;</span><br><span class="line">	<span class="keyword">struct</span> objc_protocol_list *protocols					 OBJC2_UNAVAILABLE;</span><br><span class="line"><span class="meta">#endif</span></span><br><span class="line">&#125; OBJC2_UNAVAILABLE;</span><br></pre></td></tr></table></figure>
<p><code>objc_ivar_list</code>是成员变量列表,里面存储着<code>objc_ivar</code>数组列表,<code>objc_ivar</code>结构体中存储单个成员变量的信息。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> objc_ivar_list&#123;</span><br><span class="line">	<span class="keyword">int</span> ivar_count										OBJC2_UNAVAILABLE; </span><br><span class="line"><span class="meta">#ifdef __LP64__</span></span><br><span class="line">	<span class="keyword">int</span> space											 OBJC2_UNAVAILABLE;</span><br><span class="line"><span class="meta">#endif</span></span><br><span class="line">	<span class="comment">/* variable length structure */</span></span><br><span class="line">	<span class="keyword">struct</span> objc_ivar ivar_list[<span class="number">1</span>]						 OBJC2_UNAVAILABLE;</span><br><span class="line">&#125;														 OBJC2_UNAVAILABLE;</span><br></pre></td></tr></table></figure>
<p><code>objc_method_list</code>是方法列表，里面存储着<code>objc_method</code>数组列表，<code>objc_method</code>结构体中存储着方法的信息。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> objc_method_list &#123;</span><br><span class="line">	<span class="keyword">struct</span> objc_method_list *obsolete						OBJC2_UNAVAILABLE;</span><br><span class="line">	<span class="keyword">int</span> method_count										 OBJC2_UNAVAILABLE;</span><br><span class="line"><span class="meta">#ifdef __LP64__</span></span><br><span class="line">	<span class="keyword">int</span> space												OBJC2_UNAVAILABLE;</span><br><span class="line"><span class="meta">#endif</span></span><br><span class="line">	<span class="comment">/* variable length structure */</span></span><br><span class="line">	<span class="keyword">struct</span> objc_method method_list[<span class="number">1</span>]						OBJC2_UNAVAILABLE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Method"><a href="#Method" class="headerlink" title="Method"></a>Method</h2><p><code>Method</code>代表方法的类型</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> objc_method *Method;</span><br></pre></td></tr></table></figure>
<p><code>SEL</code>是方法选择器。存储着方法的名字。同一个方法在不同类中实现，SEL相同。即使方法名字相同参数类型不同SEL一样相同。</p>
<p><code>method_types</code>是一个char类型指针。存储着返回值与参数的类型。</p>
<p><code>method_imp</code>指向了方法的实现。本质上是一个函数指针。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> objc_method&#123;</span><br><span class="line">	SEL method_name										  OBJC2_UNAVAILABLE;</span><br><span class="line">	<span class="keyword">char</span> *method_types									   OBJC2_UNAVAILABLE;</span><br><span class="line">	IMP method_imp										   OBJC2_UNAVAILABLE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Ivar"><a href="#Ivar" class="headerlink" title="Ivar"></a>Ivar</h2><p><code>Ivar</code>代表的是类中实例变量的类型。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> objc_ivar *Ivar;</span><br></pre></td></tr></table></figure>
<p><code>ivar_name</code>存储变量名</p>
<p><code>ivar_type</code>存储变量类型</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> objc_ivar&#123;</span><br><span class="line">	<span class="keyword">char</span> *ivar_name										  OBJC2_UNAVAILABLE;</span><br><span class="line">	<span class="keyword">char</span> *ivar_type										  OBJC2_UNAVAILABLE;</span><br><span class="line">	<span class="keyword">int</span> ivar_offset										  OBJC2_UNAVAILABLE;</span><br><span class="line"><span class="meta">#ifdef __LP64__</span></span><br><span class="line">	<span class="keyword">int</span> space											  OBJC2_UNAVAILABLE;</span><br><span class="line"><span class="meta">#endif</span></span><br><span class="line">&#125;														  OBJC2_UNAVAILABLE;</span><br></pre></td></tr></table></figure>
<p>根据实例查找其在类中的名字</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">-(<span class="built_in">NSString</span> *)nameWithInstance:(<span class="keyword">id</span>)instance&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> numIvars = <span class="number">0</span>;</span><br><span class="line">	<span class="built_in">NSString</span> *key = <span class="literal">nil</span>;</span><br><span class="line">	Ivar *ivars = class_copyIvarList([<span class="keyword">self</span> class],&amp;numIvars);</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>, i &lt; numIvars , i ++)&#123;</span><br><span class="line">		Ivar thisIvar = ivars[i];</span><br><span class="line">		<span class="keyword">const</span> <span class="keyword">char</span> *type = ivar_getTypeEncoding(thisIvar);</span><br><span class="line">		<span class="built_in">NSString</span> *stringType = [<span class="built_in">NSString</span> stringWithCString:type encoding:<span class="built_in">NSUTF8StringEncoding</span>];</span><br><span class="line">		<span class="keyword">if</span>(![stringType hasPrefix:<span class="string">@"@"</span>])&#123;</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>((object_getIvar(<span class="keyword">self</span>,thisIvar) == instance))&#123;</span><br><span class="line">			key = [<span class="built_in">NSString</span> stringWithUTF8String:ivar_getName:(thisIvar)];</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	free(ivars);</span><br><span class="line">	<span class="keyword">return</span> key;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>class_copyIvarList</code>获取类的成员变量列表，不仅仅是成员变量，还包含属性，属性会在原本属性名之前加_。<br><code>ivar_getTypeEncoding</code>获取实例变量的名字<code>ivar_name</code></p>
<h2 id="IMP"><a href="#IMP" class="headerlink" title="IMP"></a>IMP</h2><p><code>IMP</code>是一个指向方法实现的函数指针。当一个Objc消息发送后，最终会执行哪段代码都是有它来指定的。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">id</span>(*IMP)(<span class="keyword">id</span>,SEL,...);</span><br></pre></td></tr></table></figure>
<h2 id="Cache"><a href="#Cache" class="headerlink" title="Cache"></a>Cache</h2><p><code>Cache</code>在类方法中充当类似路由表的作用，当一个方法被调用过一次后，就是缓存在Cache中，第二次调用的时候不会直接遍历方法列表，而是优先在Cache中直接查找方法实现。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> objc_caceh *Cache;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> objc_cache &#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> mask <span class="comment">/* total = mask + 1 */</span>						  OBJC2_UNAVAILABLE;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> occupied											 OBJC2_UNAVAILABLE;</span><br><span class="line">	Method buckets[<span class="number">1</span>]												 OBJC2_UNAVAILABLE;</span><br></pre></td></tr></table></figure>
<h2 id="Property"><a href="#Property" class="headerlink" title="Property"></a>Property</h2><p><code>@property</code>标记了类中的属性，它是一个指向objc_property结构体的指针：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> objc_property *Property</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> objc_property *objc_property_t</span><br></pre></td></tr></table></figure>
<p><code>class_copyPropertyList</code> 与 <code>protocol_copyPropertyList</code>方法可用来获取类中或者协议中的属性。函数的返回值是一个指向指针的指针，返回值是一个指向数组的指针,数组中存储的是<code>objc_property_t</code>指针。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">objc_property_t *class_copyPropertyList(Class cls,<span class="keyword">unsigned</span> <span class="keyword">int</span> *outCount)</span><br><span class="line">objc_property_t *protocol_copyPropertyList(Protocol *proto , <span class="keyword">unsigned</span> <span class="keyword">int</span> *outCount)</span><br></pre></td></tr></table></figure>
<p><code>property_getName</code>通过属性获取属性名称。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> *property_getName(objc_property_t property)</span><br></pre></td></tr></table></figure>
<p><code>class_getProperty</code> <code>protocol_getProperty</code>通过属性名来获取属性</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">objc_property_t class_getProperty(Class cls, <span class="keyword">const</span> <span class="keyword">char</span> *name)</span><br><span class="line">objc_property_t protocol_getProperty(Protocol *proto , <span class="keyword">const</span> <span class="keyword">char</span> * name, <span class="built_in">BOOL</span> isRequiredProperty, <span class="built_in">BOOL</span> isInstanceProperty)</span><br></pre></td></tr></table></figure>
<p><code>property_getAttributes</code>获取属性的名称和<code>@encode</code>字符串</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> *property_getAttributes(objc_property_t property)</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/05/13/GCD/" itemprop="url">
                  GCD学习笔记
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-05-13T14:44:24+08:00" content="2016-05-13">
              2016-05-13
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/技术/" itemprop="url" rel="index">
                    <span itemprop="name">技术</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/05/13/GCD/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/05/13/GCD/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <a id="more"></a>
<h1 id="GCDDemo"><a href="#GCDDemo" class="headerlink" title="GCDDemo"></a>GCDDemo</h1><h2 id="任务-需要做的事情，一般是block。有异步执行与同步执行两种执行方式。"><a href="#任务-需要做的事情，一般是block。有异步执行与同步执行两种执行方式。" class="headerlink" title="任务:需要做的事情，一般是block。有异步执行与同步执行两种执行方式。"></a>任务:需要做的事情，一般是block。有异步执行与同步执行两种执行方式。</h2><p>任务同步于异步的区别在于是否会阻塞当前线程。同步任务会阻塞当前线程，直到执行完当前block中的任务。异步任务不会阻塞当前线程，当前线程会继续往下执行。</p>
<h3 id="创建任务-同步任务："><a href="#创建任务-同步任务：" class="headerlink" title="创建任务#### 同步任务："></a>创建任务#### 同步任务：</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dispatch_sync</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">       <span class="built_in">NSLog</span>(<span class="string">@"sync"</span>);</span><br><span class="line">   &#125;);</span><br></pre></td></tr></table></figure>
<h4 id="异步任务："><a href="#异步任务：" class="headerlink" title="异步任务："></a>异步任务：</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dispatch_async</span>(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>), ^&#123;</span><br><span class="line">       <span class="built_in">NSLog</span>(<span class="string">@"async"</span>);</span><br><span class="line">   &#125;);</span><br></pre></td></tr></table></figure>
<h2 id="队列-用来存放任务的容器。分为串行队列与并行队列。"><a href="#队列-用来存放任务的容器。分为串行队列与并行队列。" class="headerlink" title="队列:用来存放任务的容器。分为串行队列与并行队列。"></a>队列:用来存放任务的容器。分为串行队列与并行队列。</h2><p>串行队列中的任务会依次按照顺序来执行。并行队列中的任务会同步的去执行，无顺序之分。</p>
<table>
<thead>
<tr>
<th></th>
<th>同步执行</th>
<th>异步执行</th>
</tr>
</thead>
<tbody>
<tr>
<td>串行队列</td>
<td>在当前线程按顺序执行</td>
<td>新开一个线程按顺序执行</td>
</tr>
<tr>
<td>并行队列</td>
<td>在当前线程按顺序执行</td>
<td>在多个线程中同步执行</td>
</tr>
</tbody>
</table>
<h3 id="创建队列-串行线程-并行线程"><a href="#创建队列-串行线程-并行线程" class="headerlink" title="创建队列:串行线程 并行线程"></a>创建队列:串行线程 并行线程</h3><h4 id="自定义队列：使用dispatch-queue-create来创建自定义队列。"><a href="#自定义队列：使用dispatch-queue-create来创建自定义队列。" class="headerlink" title="自定义队列：使用dispatch_queue_create来创建自定义队列。"></a>自定义队列：使用dispatch_queue_create来创建自定义队列。</h4><p>第一个参数：用来最为队列的唯一标识。</p>
<p>第二个参数：用来标记创建串行队列还是并行队列。<code>DISPATCH_QUEUE_SERIAL</code> 或 <code>NULL</code> 创建串行队列，<code>DISPATCH_QUEUE_CONCURRENT</code>创建并行队列。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建同步队列</span></span><br><span class="line">  <span class="built_in">dispatch_queue_t</span> seriver = dispatch_queue_create(<span class="string">"serialqueue"</span>, DISPATCH_QUEUE_SERIAL); </span><br><span class="line">  <span class="comment">//串行队列</span></span><br><span class="line">  <span class="built_in">dispatch_queue_t</span> concurrent2 = dispatch_queue_create(<span class="string">"concurrentqueue2"</span>, <span class="literal">NULL</span>);</span><br><span class="line">  <span class="comment">//创建并行队列</span></span><br><span class="line">  <span class="built_in">dispatch_queue_t</span> concurrent = dispatch_queue_create(<span class="string">"concurrentqueue"</span>, DISPATCH_QUEUE_CONCURRENT);</span><br></pre></td></tr></table></figure>
<h4 id="系统队列"><a href="#系统队列" class="headerlink" title="系统队列"></a>系统队列</h4><p>  除了自定义队列，还可以使用系统所提供的两个队列。主队列与系统提供的并行队列。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Main Queue</span></span><br><span class="line">    <span class="built_in">dispatch_queue_t</span> mainqueue = dispatch_get_main_queue();</span><br><span class="line">    <span class="comment">//Global Queue</span></span><br><span class="line">    <span class="built_in">dispatch_queue_t</span> global = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>
<p><code>dispatch_get_global_queue(long identifier, unsigned long flags)</code><br>  用来获取系统所提供的Global并行队列。identifier参数是用来标识队列的优先级。Global Queue存在4个优先级：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#define DISPATCH_QUEUE_PRIORITY_HIGH 2</span></span><br><span class="line"><span class="meta">#define DISPATCH_QUEUE_PRIORITY_DEFAULT 0</span></span><br><span class="line"><span class="meta">#define DISPATCH_QUEUE_PRIORITY_LOW (-2)</span></span><br><span class="line"><span class="meta">#define DISPATCH_QUEUE_PRIORITY_BACKGROUND INT16_MIN</span></span><br><span class="line"><span class="comment">/*Global Queue优先级</span><br><span class="line">   dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^&#123;</span><br><span class="line">       NSLog(@"default");</span><br><span class="line">   &#125;);</span><br><span class="line">   dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_LOW, 0), ^&#123;</span><br><span class="line">       NSLog(@"low");</span><br><span class="line">   &#125;);</span><br><span class="line">   dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_HIGH, 0), ^&#123;</span><br><span class="line">       NSLog(@"high");</span><br><span class="line">   &#125;);</span><br><span class="line">   dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_BACKGROUND, 0), ^&#123;</span><br><span class="line">       NSLog(@"background");</span><br><span class="line">   &#125;);</span></span><br></pre></td></tr></table></figure>
<h2 id="dispatch-set-target-queue"><a href="#dispatch-set-target-queue" class="headerlink" title="dispatch_set_target_queue"></a>dispatch_set_target_queue</h2><p>  系统所提供的Global Queue可以通过参数来设置优先级。自定义的队列也可以通过<code>dispatch_set_target_queue</code>函数来修改执行时的优先级。<code>dispatch_set_target_queue:</code>为给定的对象设置target Queue。我的理解是将给定的队列添加到另一个队列中。所以自定义的队列可以添加到Global Queue中,通过修改Global Queue优先级来修改自定义队列的优先级。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建并行队列</span></span><br><span class="line">    <span class="built_in">dispatch_queue_t</span> concurrent = dispatch_queue_create(<span class="string">"concurrent"</span>, DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line">    <span class="comment">//获取Global Queue</span></span><br><span class="line">    <span class="built_in">dispatch_queue_t</span> global = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_LOW, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">//将自定义队列加入Global Queue中    </span></span><br><span class="line">    dispatch_set_target_queue(concurrent, global);</span><br><span class="line">    <span class="built_in">dispatch_async</span>(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_BACKGROUND, <span class="number">0</span>), ^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"background"</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="built_in">dispatch_async</span>(concurrent, ^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"low"</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="built_in">dispatch_async</span>(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_HIGH, <span class="number">0</span>), ^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"high"</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">``` </span><br><span class="line">  </span><br><span class="line"><span class="meta">## dispatch_after</span></span><br><span class="line">  主队列中无法通过调用sleep来延迟调用，会造成界面卡死。所以可以通过dispatch_after来实现延迟调用效果。</span><br><span class="line">  	</span><br><span class="line">```objc</span><br><span class="line">	<span class="built_in">NSLog</span>(<span class="string">@"1"</span>);</span><br><span class="line">    dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(<span class="number">5</span> * <span class="built_in">NSEC_PER_SEC</span>)), dispatch_get_main_queue(), ^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"2"</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">``` </span><br><span class="line">  </span><br><span class="line"><span class="meta">## 队列组</span></span><br><span class="line">队列组可以将许多队列添加到一个组里来执行。当队列组内的任务都执行完成了，可以通过`dispatch_group_notify`来接收组内任务完成的通知。这样我们就可以知道任务是何时全部完成。</span><br><span class="line"></span><br><span class="line">```objc</span><br><span class="line"><span class="built_in">dispatch_queue_t</span> queue = dispatch_queue_create(<span class="string">"concurrent"</span>, DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line">    dispatch_group_t group = dispatch_group_create();</span><br><span class="line">    dispatch_group_async(group, queue, ^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"queue task 1"</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    dispatch_group_async(group, queue, ^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"queue task 2"</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    dispatch_group_async(group, queue, ^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"queue task 3"</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    dispatch_group_async(group, queue, ^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"queue task 4"</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    dispatch_group_notify(group, dispatch_get_main_queue(), ^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"task finished"</span>);</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>
<h2 id="dispatch-barrier-async"><a href="#dispatch-barrier-async" class="headerlink" title="dispatch_barrier_async"></a>dispatch_barrier_async</h2><pre><code class="objc"><span class="built_in">dispatch_queue_t</span> concurrent = dispatch_queue_create(<span class="string">"concurrent"</span>, DISPATCH_QUEUE_CONCURRENT);
<span class="built_in">dispatch_async</span>(concurrent, ^{
    <span class="built_in">NSLog</span>(<span class="string">@"one"</span>);
});
<span class="built_in">dispatch_async</span>(concurrent, ^{
    <span class="built_in">NSLog</span>(<span class="string">@"two"</span>);
});
<span class="built_in">dispatch_async</span>(concurrent, ^{
    <span class="built_in">NSLog</span>(<span class="string">@"three"</span>);
});
<span class="built_in">dispatch_async</span>(concurrent, ^{
    <span class="built_in">NSLog</span>(<span class="string">@"four"</span>);
});
dispatch_barrier_async(concurrent, ^{
    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span> ; i++) {
        <span class="built_in">NSLog</span>(<span class="string">@"%d"</span>,i);
    }
});
<span class="built_in">dispatch_async</span>(concurrent, ^{
    <span class="built_in">NSLog</span>(<span class="string">@"five"</span>);
});
<span class="built_in">dispatch_async</span>(concurrent, ^{
    <span class="built_in">NSLog</span>(<span class="string">@"six"</span>);
});
<span class="built_in">dispatch_async</span>(concurrent, ^{
    <span class="built_in">NSLog</span>(<span class="string">@"seven"</span>);
});
<span class="built_in">dispatch_async</span>(concurrent, ^{
    <span class="built_in">NSLog</span>(<span class="string">@"eight"</span>);
});
</code></pre>
<p>dispatch_barrier_async会在当线程当前任务完成后阻塞线程，直到block执行完成之后，才能执行后面的任务。<br>dispatch_barrier_sync:等待当前线程的任务全部执行完再阻塞线程，直到block执行完成，才能执行接下来的任务。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.JPG"
               alt="Ctf" />
          <p class="site-author-name" itemprop="name">Ctf</p>
          <p class="site-description motion-element" itemprop="description">Fake it until make it !</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">4</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">2</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">1</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/c826" target="_blank" title="github">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  github
                </a>
              </span>
            
          
        </div>

        
        

        
        

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Ctf</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>
        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"ctf826"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
  






  
  
  

  

  

</body>
</html>
